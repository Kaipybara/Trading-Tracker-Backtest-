<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Trading Tracker 5.1</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0f1222;
      --bg-soft:#171a2d;
      --card:#1d2140;
      --card-2:#1a1e3a;
      --text:#e7e9f0;
      --muted:#9aa1c6;
      --line:#2b315d;
      --green:#35cc7a;
      --red:#ff5a6b;
      --amber:#ffc857;
      --blue:#4ea1ff;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:12px;
      --gap:16px;
      --block-gap:22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 1200px at 80% -20%, #3f3cbb22 0%, transparent 60%),
        radial-gradient(1200px 1200px at -10% 120%, #4ea1ff22 0%, transparent 60%),
        var(--bg);
      color:var(--text);
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, system-ui, Avenir, "Helvetica Neue", Arial, "Noto Sans";
      line-height:1.35;
    }

    /* ---------- Top App Bar ---------- */
    .appbar{
      position:sticky; top:0; z-index:40;
      backdrop-filter:saturate(120%) blur(12px);
      background:rgba(15,18,34,.7);
      border-bottom:1px solid var(--line);
    }
    .appbar-inner{
      max-width:1300px; margin:0 auto; padding:12px 16px;
      display:flex; gap:16px; align-items:center; flex-wrap:wrap;
    }
    .brand{font-weight:700; letter-spacing:.2px; font-size:18px; margin-right:auto; display:flex; align-items:center; gap:10px}
    .brand small{color:var(--muted); font-weight:500}

    .seg{
      display:inline-flex; background:var(--card); border:1px solid var(--line); border-radius:999px; overflow:hidden;
    }
    .seg button{
      padding:8px 14px; border:0; background:transparent; color:var(--muted); cursor:pointer; font-weight:700;
    }
    .seg button.active{background:var(--blue); color:white}

    .btn{
      border:0; background:var(--card-2); color:var(--text); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; box-shadow:var(--shadow);
    }
    .btn:active{transform:translateY(1px)}
    .btn.blue{background:linear-gradient(180deg, #4ea1ff, #277ae3)}
    .btn.soft{background:var(--card); border:1px solid var(--line); box-shadow:none; color:var(--muted); font-weight:600}
    .btn.green{background:linear-gradient(180deg, #27be69, #149a53)}
    .btn.red{background:linear-gradient(180deg, #ff5a6b, #d93c4f)}
    .btn.big{width:100%; padding:14px 16px; font-size:18px; font-weight:900; border-radius:12px;}

    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}

    .kbd{
      padding:2px 6px; border:1px solid var(--line); border-bottom-width:2px; background:var(--bg-soft); border-radius:6px; color:var(--muted); font-size:12px
    }

    input, select, textarea{
      background:var(--bg-soft); border:1px solid var(--line); color:var(--text); border-radius:8px; padding:8px 10px; outline:none;
      min-height:36px;
    }
    label{color:var(--muted); font-size:12px}

    /* ---------- Page ---------- */
    .shell{max-width:1300px; margin:0 auto; padding:18px 16px 80px}
    .tabcontent{display:none; margin-top:16px}
    .tabcontent.active{display:block; animation:fade .25s ease}
    @keyframes fade{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}

    .grid{display:grid; gap:var(--gap)}
    .grid.cols-2{grid-template-columns:2fr 3fr}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .grid.cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}
    @media (max-width:1100px){ .grid.cols-4{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:900px){ .grid.cols-2{grid-template-columns:1fr} .grid.cols-3{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:680px){ .grid.cols-3{grid-template-columns:1fr} }

    .stack > .card{ margin-bottom:var(--block-gap); }
    .stack .grid{ gap:calc(var(--gap) + 6px); }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow)
    }
    .card h3{margin:0 0 12px 0; font-size:16px; letter-spacing:.2px}
    .kpis{display:grid; grid-template-columns:repeat(5,minmax(0,1fr)); gap:var(--gap)}
    @media (max-width:1000px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:600px){ .kpis{grid-template-columns:1fr} }
    .kpi{background:var(--card-2); border:1px solid var(--line); border-radius:12px; padding:14px; overflow:hidden}
    .kpi .label{color:var(--muted); font-size:12px; margin-bottom:6px}
    .kpi .value{font-size:22px; font-weight:800; word-break:break-word}

    table{width:100%; border-collapse:collapse}
    th, td{padding:10px 8px; border-bottom:1px solid var(--line); text-align:left; font-size:14px}
    thead th{color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.4px}
    tbody tr:hover{background:rgba(255,255,255,.03)}

    /* ---------- Quick Entry Dock (only on Backtest) ---------- */
    .quick-dock{
      position:sticky; top:76px; z-index:35;
      background:linear-gradient(180deg, rgba(26,30,58,.9), rgba(26,30,58,.86));
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      box-shadow:var(--shadow);
      display:grid;
      grid-template-columns: 1.2fr 1.6fr 1.2fr 1.2fr;
      gap:10px;
      align-items:center;
      margin-bottom:var(--block-gap);
    }
    @media (max-width:980px){ .quick-dock{ grid-template-columns:1.2fr 1.6fr 1fr 1fr; } }
    @media (max-width:760px){ .quick-dock{ grid-template-columns:1fr; top:64px } }
    .quick-dock.hidden{display:none}
    .dock-group{
      display:flex; align-items:center; gap:8px; width:100%;
      background:var(--bg-soft); border:1px solid var(--line); border-radius:10px; padding:8px;
    }
    .dock-group .seg{background:transparent; border:0}
    .dock-group .seg button{min-width:92px}
    .icon-btn{background:transparent; border:0; color:var(--muted); cursor:pointer; font-size:18px}
    .icon-btn:hover{color:#fff}
    .hint{color:var(--muted); font-size:12px; margin-top:4px; text-align:center}

    /* ---------- Screenshot area ---------- */
    .shot-card .shot-drop{
      border:2px dashed #3a4177; border-radius:12px;
      background:linear-gradient(0deg, #161a33bb, #161a33aa);
      padding:12px; min-height:120px; display:flex; align-items:center; justify-content:center; text-align:center; color:var(--muted);
      cursor:text;
    }
    .shot-card .shot-drop.focus{outline:2px solid var(--blue); outline-offset:2px}
    .shot-card .shot-img{display:block; width:100%; height:auto; border-radius:10px; margin-top:12px; border:1px solid var(--line)}
    .shot-tools{display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:8px}

    .muted{color:var(--muted)}
    .sr{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}

    /* Toasts */
    .toast{position:fixed; right:16px; bottom:16px; z-index:60}
    .toast .t{background:#1e223f; color:#e7e9f0; border:1px solid #2b315d; border-radius:10px; padding:10px 12px; margin-top:8px; box-shadow:var(--shadow); font-size:14px}
    .toast .undo{margin-left:10px; color:#4ea1ff; cursor:pointer; font-weight:700}

    /* Analytics */
    .progress{height:8px; border-radius:999px; background:#1c2144; border:1px solid #2b315d; overflow:hidden}
    .progress > div{height:100%; background:linear-gradient(90deg, #4ea1ff, #277ae3); width:0%}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; color:#cfd2e6}

    /* Unit config panel (appears only for $ modes) */
    .unit-config{
      display:none; max-width:1300px; margin:8px auto 0;
      background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px;
      box-shadow:var(--shadow);
    }
    .unit-config.show{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .unit-config .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .unit-config .note{color:var(--muted); font-size:12px}
  </style>
</head>

<body>
  <!-- ========== TOP BAR ========== -->
  <header class="appbar" role="banner">
    <div class="appbar-inner">
      <div class="brand">
        <span>📊 Trading Tracker</span>
        <small id="fileBadge">Unsaved</small>
      </div>

      <!-- Tabs -->
      <div class="seg" role="tablist" aria-label="Views">
        <button class="active" id="tabBtn-backtest" role="tab" aria-selected="true" data-tab="backtest">Backtest</button>
        <button id="tabBtn-report" role="tab" aria-selected="false" data-tab="report">Report</button>
        <button id="tabBtn-analytics" role="tab" aria-selected="false" data-tab="analytics">Deep Analytics</button>
      </div>

      <!-- Unit + File actions -->
      <div class="toolbar" style="margin-left:auto">
        <div class="seg" aria-label="Units">
          <button id="unitR" class="active">Unit: R</button>
          <button id="unitDollarFlat">Unit: $ (flat)</button>
          <button id="unitDollarComp">Unit: $ (comp)</button>
        </div>

        <button class="btn blue" id="saveBtn" title="Save JSON (S)">Save <span class="kbd">S</span></button>
        <input class="sr" type="file" id="loadInput" accept=".json" />
        <button class="btn soft" id="loadBtn">Load</button>
        <button class="btn soft" id="exportBtn">Export CSV</button>
      </div>
    </div>

    <!-- Unit configuration panel (appears when $ modes selected) -->
    <div id="unitConfig" class="unit-config" aria-live="polite"></div>
  </header>

  <!-- ========== MAIN ========== -->
  <main class="shell">

    <!-- QUICK ENTRY DOCK (only on Backtest) -->
    <section class="quick-dock" id="quickDock" aria-label="Quick Entry">
      <!-- Date -->
      <div>
        <div class="dock-group" aria-label="Date control">
          <button class="icon-btn" id="prevDay" title="Previous day (←)">⟨</button>
          <input type="date" id="dateInput" aria-label="Selected date" style="flex:1" />
          <button class="icon-btn" id="nextDay" title="Next day (→)">⟩</button>
          <button class="btn soft" id="todayBtn" title="Jump to today">Today</button>
        </div>
        <div class="hint">Use ← / → to move days</div>
      </div>

      <!-- Setup -->
      <div>
        <div class="dock-group" aria-label="Setup">
          <span class="muted" style="padding-left:6px">Setup</span>
          <div class="seg" style="margin-left:6px">
            <button class="active" data-setup="Breakout">Breakout</button>
            <button data-setup="Reversal">Reversal</button>
            <button data-setup="Engulfing">Engulfing</button>
          </div>
        </div>
        <div class="hint">Press 1 / 2 / 3 to switch</div>
      </div>

      <!-- Win -->
      <div>
        <button class="btn big green" id="winBtn" title="Record Win (↑)">Win <span class="kbd">↑</span></button>
        <div class="hint">Adds +2R to today</div>
      </div>

      <!-- Lose -->
      <div>
        <button class="btn big red" id="loseBtn" title="Record Lose (↓)">Lose <span class="kbd">↓</span></button>
        <div class="hint">Adds -1R to today</div>
      </div>
    </section>

    <!-- BACKTEST -->
    <section id="tab-backtest" class="tabcontent active stack" role="tabpanel" aria-labelledby="tabBtn-backtest">
      <div class="grid cols-2" style="margin-top:12px">
        <!-- Left: Day stats -->
        <div class="grid">
          <div class="card">
            <h3>Day Stats (<span id="dayLabel">—</span>)</h3>
            <div class="grid cols-3" style="margin-top:10px">
              <div class="kpi"><div class="label">Wins</div><div class="value" id="wins">0</div></div>
              <div class="kpi"><div class="label">Losses</div><div class="value" id="losses">0</div></div>
              <div class="kpi"><div class="label">Total</div><div class="value" id="total">0</div></div>
              <div class="kpi"><div class="label">Win Rate</div><div class="value" id="winRate">0%</div></div>
              <div class="kpi"><div class="label">Total R</div><div class="value" id="totalR">0.0R</div></div>
              <div class="kpi"><div class="label">Expectancy</div><div class="value" id="expectancy">0.00R</div></div>
            </div>
          </div>

          <div class="card">
            <h3>Quick Notes</h3>
            <textarea id="dayNote" rows="5" placeholder="Optional: context for today's trades…" style="width:100%; resize:vertical"></textarea>
            <div style="display:flex; gap:8px; margin-top:10px">
              <button class="btn soft" id="resetDayBtn" title="Reset current day (R)">Reset Day <span class="kbd">R</span></button>
              <button class="btn soft" id="resetAllBtn">Reset All</button>
            </div>
          </div>
        </div>

        <!-- Right: Today table -->
        <div class="card">
          <h3>Today Entries</h3>
          <div style="overflow:auto; max-height:480px; margin-top:8px">
            <table id="todayTable" aria-label="Today table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Setup</th>
                  <th>Wins</th>
                  <th>Losses</th>
                  <th>Total</th>
                  <th>Win %</th>
                  <th>Total R</th>
                  <th>Expectancy</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="todayTableBody">
                <tr><td colspan="9" class="muted" style="text-align:center">No data for this day yet</td></tr>
              </tbody>
              <tfoot>
                <tr>
                  <td><strong>TOTAL</strong></td>
                  <td>—</td>
                  <td id="sumWins">0</td>
                  <td id="sumLosses">0</td>
                  <td id="sumTotal">0</td>
                  <td id="sumWinRate">0%</td>
                  <td id="sumR">0.0R</td>
                  <td id="sumExp">0.00R</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- Screenshot section -->
      <div class="card shot-card" style="margin-top:16px">
        <h3>Screenshot</h3>
        <div id="shotDrop" class="shot-drop" tabindex="0" aria-label="Paste area">
          <div>
            <div><strong>Click here</strong> and press <b>Ctrl/Cmd + V</b> to paste a screenshot. No permissions needed.</div>
            <div class="muted" style="margin-top:6px">Image is stored at full size and saved with your JSON.</div>
          </div>
        </div>
        <img id="shotImg" class="shot-img" alt="Screenshot for this day" style="display:none" />
        <div class="shot-tools" id="shotTools" style="display:none">
          <button class="btn soft" id="openShot">Open in new tab</button>
          <button class="btn soft" id="clearShot">Clear Screenshot</button>
        </div>
      </div>
    </section>

    <!-- REPORT -->
    <section id="tab-report" class="tabcontent stack" role="tabpanel" aria-labelledby="tabBtn-report">
      <!-- Filter bar -->
      <div class="card" id="reportFilterBar">
        <div class="grid cols-3">
          <div>
            <label for="startDate">From</label>
            <input type="date" id="startDate" style="width:100%">
          </div>
          <div>
            <label for="endDate">To</label>
            <input type="date" id="endDate" style="width:100%">
          </div>
          <div style="display:flex; align-items:flex-end; gap:8px">
            <button class="btn" id="applyRange">Apply</button>
            <button class="btn soft" id="clearRangeBtn">Clear</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Summary</h3>
        <div class="kpis" style="margin-top:10px">
          <div class="kpi"><div class="label">Total Trades</div><div class="value" id="kpiTrades">0</div></div>
          <div class="kpi"><div class="label">Net Profit</div><div class="value" id="kpiNet">0R</div></div>
          <div class="kpi"><div class="label">Win Rate</div><div class="value" id="kpiWR">0%</div></div>
          <div class="kpi"><div class="label">Expectancy</div><div class="value" id="kpiExp">0R</div></div>
          <div class="kpi"><div class="label">Max Drawdown</div><div class="value" id="kpiDD">0R</div></div>
          <div class="kpi"><div class="label">Total Day Span</div><div class="value" id="kpiDaySpan">0</div></div>
          <div class="kpi"><div class="label">Total Month Span</div><div class="value" id="kpiMonthSpan">0</div></div>
          <div class="kpi"><div class="label">Total Quarter Span</div><div class="value" id="kpiQuarterSpan">0</div></div>
          <div class="kpi"><div class="label">Total Year Span</div><div class="value" id="kpiYearSpan">0</div></div>
          <div class="kpi"><div class="label">Avg Trades / Day</div><div class="value" id="kpiAvgPerDay">0.00</div></div>
        </div>
      </div>

      <div class="card">
        <div class="chart-head" style="display:flex; align-items:center; gap:10px">
          <h3 style="margin:0" id="equityTitle">Cumulative Equity</h3>
          <div class="spacer" style="flex:1"></div>
          <div class="seg" id="granSeg" aria-label="Granularity">
            <button class="active" data-gran="daily">Daily</button>
            <button data-gran="weekly">Weekly</button>
            <button data-gran="monthly">Monthly</button>
          </div>
        </div>
        <div style="height:360px"><canvas id="equityChart" aria-label="Equity chart"></canvas></div>
        <div class="grid cols-4" style="margin-top:12px">
          <div class="kpi"><div class="label">Starting Equity</div><div class="value" id="startEquity">0R</div></div>
          <div class="kpi"><div class="label">Current Equity</div><div class="value" id="currEquity">0R</div></div>
          <div class="kpi"><div class="label">Peak Equity</div><div class="value" id="peakEquity">0R</div></div>
          <div class="kpi"><div class="label">Max Drawdown</div><div class="value" id="chartDD">0R</div></div>
        </div>
      </div>

      <div class="card">
        <h3>Setup Performance</h3>
        <div id="setupCards" class="grid cols-3" style="margin-top:10px"></div>
      </div>

      <div class="grid cols-2">
        <div class="card">
          <h3>Daily Outcomes</h3>
          <div class="grid cols-3" style="margin-top:8px">
            <div class="kpi"><div class="label">Winning Days</div><div class="value" id="winDays">0 (0%)</div></div>
            <div class="kpi"><div class="label">Losing Days</div><div class="value" id="loseDays">0 (0%)</div></div>
            <div class="kpi"><div class="label">Breakeven Days</div><div class="value" id="beDays">0 (0%)</div></div>
          </div>
        </div>

        <div class="card">
          <h3>Periodic Average</h3>
          <div class="grid cols-3" style="margin-top:8px">
            <div class="kpi"><div class="label">Daily Avg</div><div class="value" id="avgDaily">0R</div></div>
            <div class="kpi"><div class="label">Weekly Avg</div><div class="value" id="avgWeekly">0R</div></div>
            <div class="kpi"><div class="label">Monthly Avg</div><div class="value" id="avgMonthly">0R</div></div>
          </div>
        </div>
      </div>

      <div class="grid cols-2">
        <div class="card">
          <h3>Losing Streak Frequency (≥2) — by Trades</h3>
          <div style="overflow:auto; max-height:260px; margin-top:8px">
            <table id="streakTable">
              <thead><tr><th>Consecutive Losing Trades</th><th>Count</th></tr></thead>
              <tbody id="streakBody"><tr><td colspan="2" class="muted" style="text-align:center">No data</td></tr></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3>Monthly Performance</h3>
          <div style="overflow:auto; max-height:260px; margin-top:8px">
            <table id="monthlyTable">
              <thead>
                <tr><th>Month</th><th>Trades</th><th>Net</th><th>Win %</th><th>Exp</th><th>Max DD</th></tr>
              </thead>
              <tbody id="monthlyBody"><tr><td colspan="6" class="muted" style="text-align:center">No data</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section id="tab-analytics" class="tabcontent stack" role="tabpanel" aria-labelledby="tabBtn-analytics">
      <!-- Run settings on top -->
      <div class="card">
        <h3>Run Settings</h3>
        <div class="grid cols-3" style="margin-top:8px">
          <div>
            <label>Use Report Filter</label><br/>
            <input type="checkbox" id="anaUseFilter" checked />
          </div>
          <div>
            <label>Trades Horizon</label>
            <input type="number" id="anaHorizon" min="1" step="1" value="100" style="width:100%">
          </div>
          <div>
            <label>Simulations</label>
            <input type="number" id="anaSims" min="100" step="100" value="10000" style="width:100%">
          </div>
        </div>

        <div class="grid cols-3" style="margin-top:8px">
          <div>
            <label>Block Size (streaks)</label>
            <input type="number" id="anaBlock" min="1" step="1" value="1" style="width:100%">
          </div>
          <div>
            <label>Bootstrap Resamples</label>
            <input type="number" id="anaBoot" min="100" step="100" value="10000" style="width:100%">
          </div>
          <div>
            <label>Seed (optional)</label>
            <input type="number" id="anaSeed" step="1" style="width:100%">
          </div>
        </div>

        <div style="display:flex; align-items:center; gap:8px; margin-top:12px">
          <button class="btn blue" id="anaRun">Run Analytics</button>
          <button class="btn soft" id="anaClear">Clear Results</button>
          <span class="muted" id="anaStatus"></span>
        </div>

        <div class="progress" style="margin-top:10px"><div id="anaProg"></div></div>
        <div class="card" style="margin-top:12px; background:#1a1f42">
          <div class="code" id="anaMeta">—</div>
        </div>
      </div>

      <!-- Confidence full width -->
      <div class="card">
        <h3>Confidence</h3>
        <div class="grid cols-2">
          <div>
            <div class="kpi"><div class="label">Expectancy (R/trade) — 95% Bootstrap CI</div><div class="value" id="ciExp">—</div></div>
            <div style="height:220px; margin-top:8px"><canvas id="bootChart"></canvas></div>
          </div>
          <div>
            <div class="kpi"><div class="label">Win Rate — 95% Wilson CI</div><div class="value" id="ciWR">—</div></div>
            <div class="muted" style="margin-top:6px">Wilson interval assumes IID; streakiness is modeled in Monte Carlo via block sampling.</div>
          </div>
        </div>
      </div>

      <!-- Monte Carlo full width -->
      <div class="card">
        <h3>Monte Carlo Projections (in R)</h3>
        <div class="grid cols-2">
          <div style="height:260px"><canvas id="mcFan"></canvas></div>
          <div style="height:260px"><canvas id="mcFinalHist"></canvas></div>
        </div>
        <div class="grid cols-2" style="margin-top:8px">
          <div style="height:220px"><canvas id="mcDDHist"></canvas></div>
          <div class="grid">
            <div class="kpi"><div class="label">Mean Final Outcome</div><div class="value" id="mcMean">—</div></div>
            <div class="kpi"><div class="label">90% Range</div><div class="value" id="mcRange">—</div></div>
            <div class="kpi"><div class="label">Median Final Outcome</div><div class="value" id="mcMedian">—</div></div>
            <div class="kpi"><div class="label">Avg Max Drawdown</div><div class="value" id="mcAvgDD">—</div></div>
            <div class="kpi"><div class="label">DD 5–95%</div><div class="value" id="mcDDRange">—</div></div>
            <div class="kpi"><div class="label">Prob. Finish Negative</div><div class="value" id="mcNegProb">—</div></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Toasts -->
  <div class="toast" id="toast"></div>

  <script>
    // ========= State =========
    const SETUPS = ["Breakout","Reversal","Engulfing"];
    let currentDate = new Date().toISOString().slice(0,10);
    let currentSetup = SETUPS[0];
    // Shape: dailyData[date] = { note: string, screenshot?: dataURL, _events: [{setup, outcome:'W'|'L'}], [setup]:{wins,losses} }
    let dailyData = {};
    let currentFileName = null;
    let equityChart = null;
    let granularity = 'daily';
    let reportStartDate = null, reportEndDate = null;

    // Units: 'R' | 'flat' | 'comp'
    let unitMode = 'R';
    let rValue = 1; // flat dollars per R
    let compStart = 100000; // $
    let compRiskPct = 0.3; // %
    const undoStack = [];

    // Analytics cache & worker
    let anaWorker = null;
    let anaCacheKey = null;
    let anaBootChart = null, mcFanChart = null, mcFinalHistChart = null, mcDDHistChart = null;

    // ========= Helpers =========
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>document.querySelectorAll(sel);
    const fmt = (n, d=2)=>Number(n).toFixed(d);
    const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
    const isInputFocused = ()=> {
      const a = document.activeElement;
      return a && (a.tagName==='INPUT' || a.tagName==='TEXTAREA' || a.isContentEditable);
    };
    // Display date as YYYY/MM/DD
    function dispDate(s){
      if(!s) return '—';
      if(s.includes('T')) s = s.slice(0,10);
      const parts = s.split('-');
      return parts.length===3 ? `${parts[0]}/${parts[1]}/${parts[2]}` : s.replaceAll('-','/');
    }

    function pushUndo(action){ undoStack.push(action); if(undoStack.length>10) undoStack.shift(); }
    function showToast(message, withUndo){
      const box = $('#toast');
      const t = document.createElement('div');
      t.className='t';
      t.textContent = message;
      if(withUndo){
        const u = document.createElement('span');
        u.className='undo';
        u.textContent='Undo';
        u.onclick = ()=>{ try { withUndo(); } finally { box.removeChild(t); } };
        t.appendChild(u);
      }
      box.appendChild(t);
      setTimeout(()=>{ if(t.isConnected) box.removeChild(t); }, 3000);
    }

    function saveLocal(){
      const payload = {dailyData, currentDate, currentFileName, rValue, unitMode, compStart, compRiskPct, reportStartDate, reportEndDate, version:'3.1'};
      try { localStorage.setItem('tt_desktop', JSON.stringify(payload)); } catch(e) { console.warn('Local save too large?', e); }
      $('#fileBadge').textContent = currentFileName ? `File: ${currentFileName}` : 'Unsaved';
    }
    function loadLocal(){
      try{
        const raw = localStorage.getItem('tt_desktop');
        if(!raw) return;
        const data = JSON.parse(raw);
        dailyData = data.dailyData || {};
        currentDate = data.currentDate || currentDate;
        currentFileName = data.currentFileName || null;
        rValue = data.rValue ?? 1;
        unitMode = data.unitMode || 'R';
        compStart = data.compStart ?? 100000;
        compRiskPct = data.compRiskPct ?? 0.3;
        reportStartDate = data.reportStartDate || null;
        reportEndDate = data.reportEndDate || null;
      }catch(e){ console.warn('Autosave load failed', e); }
    }

    // ========= Date utils =========
    function setDate(d){
      currentDate = d;
      $('#dateInput').value = currentDate; // native input uses YYYY-MM-DD
      updateBacktestView();
      saveLocal();
    }
    function changeDate(delta){
      const dt = new Date(currentDate);
      dt.setDate(dt.getDate()+delta);
      setDate(dt.toISOString().slice(0,10));
    }
    function getISOWeek(dateStr){
      const date = new Date(dateStr);
      const day = (date.getUTCDay()||7);
      date.setUTCDate(date.getUTCDate() + 4 - day);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
      return Math.ceil((((date - yearStart)/86400000)+1)/7);
    }
    function weekKey(dateStr){
      const d = new Date(dateStr);
      return `${d.getFullYear()}-W${String(getISOWeek(dateStr)).padStart(2,'0')}`;
    }
    function quarterKey(dateStr){
      const d = new Date(dateStr);
      const q = Math.floor(d.getMonth()/3)+1;
      return `${d.getFullYear()}-Q${q}`;
    }

    // ========= Data access =========
    function ensureDay(date){
      if(!dailyData[date]) dailyData[date]={};
      if(!('note' in dailyData[date])) dailyData[date].note='';
      if(!('_events' in dailyData[date])) dailyData[date]._events=[];
    }

    function record(type){
      ensureDay(currentDate);
      if(!dailyData[currentDate][currentSetup]) dailyData[currentDate][currentSetup]={wins:0, losses:0};

      const snapshot = JSON.parse(JSON.stringify(dailyData[currentDate]));
      pushUndo(()=>{
        dailyData[currentDate] = snapshot;
        updateBacktestView(); updateReportView(); saveLocal();
      });
      showToast(`${type==='win'?'+2R win':'-1R loss'} • ${currentSetup} • ${dispDate(currentDate)}`);

      if(type==='win'){ dailyData[currentDate][currentSetup].wins++; dailyData[currentDate]._events.push({setup:currentSetup, outcome:'W'}); }
      else { dailyData[currentDate][currentSetup].losses++; dailyData[currentDate]._events.push({setup:currentSetup, outcome:'L'}); }

      updateBacktestView(); updateReportView(); saveLocal();
    }

    function deleteEntry(date, setup){
      if(!(dailyData[date] && dailyData[date][setup])) return;
      const snapshot = JSON.parse(JSON.stringify(dailyData));
      pushUndo(()=>{ dailyData = snapshot; updateBacktestView(); updateReportView(); saveLocal(); });
      delete dailyData[date][setup];
      if(dailyData[date]._events){
        dailyData[date]._events = dailyData[date]._events.filter(ev=> ev.setup !== setup);
      }
      if(Object.keys(dailyData[date]).filter(k=>k!=='note' && k!=='_events' && k!=='screenshot').length===0) delete dailyData[date];
      showToast(`Deleted ${setup} for ${dispDate(date)}`);
      updateBacktestView(); updateReportView(); saveLocal();
    }

    function resetDay(){
      if(!dailyData[currentDate]) return;
      const snapshot = JSON.parse(JSON.stringify(dailyData));
      pushUndo(()=>{ dailyData = snapshot; updateBacktestView(); updateReportView(); saveLocal(); });
      delete dailyData[currentDate];
      showToast(`Reset ${dispDate(currentDate)}`);
      updateBacktestView(); updateReportView(); saveLocal();
    }

    function resetAll(){
      if(Object.keys(dailyData).length===0) return;
      const snapshot = JSON.parse(JSON.stringify(dailyData));
      pushUndo(()=>{ dailyData = snapshot; updateBacktestView(); updateReportView(); saveLocal(); });
      dailyData={};
      showToast(`All data cleared`);
      updateBacktestView(); updateReportView(); saveLocal();
    }

    // ========= Filters =========
    function filteredData(){
      if(!reportStartDate || !reportEndDate) return dailyData;
      const out = {};
      for(const d of Object.keys(dailyData)){
        if(d>=reportStartDate && d<=reportEndDate){
          out[d] = dailyData[d];
        }
      }
      return out;
    }

    // ========= Trade sequences & aggregates =========
    function getTradeOutcomes(dataObj){
      const arr = [];
      for(const d of Object.keys(dataObj)){
        for(const [k,v] of Object.entries(dataObj[d])){
          if(['note','_events','screenshot'].includes(k)) continue;
          for(let i=0;i<(v.wins||0);i++) arr.push(2);
          for(let i=0;i<(v.losses||0);i++) arr.push(-1);
        }
      }
      return arr;
    }
    function buildTradeSequence(dataObj){
      const dates = Object.keys(dataObj).sort();
      const seq = [];
      dates.forEach(date=>{
        const day = dataObj[date];
        if(day._events && day._events.length){
          day._events.forEach(ev=> seq.push(ev.outcome));
        }else{
          let w=0, l=0;
          for(const [k,v] of Object.entries(day)){
            if(k==='note' || k==='_events' || k==='screenshot') continue;
            w += v.wins || 0;
            l += v.losses || 0;
          }
          while(w>0 || l>0){ if(w>0){ seq.push('W'); w--; } if(l>0){ seq.push('L'); l--; } }
        }
      });
      return seq.map(ch=> ch==='W' ? 2 : -1);
    }

    function aggregateR(dataObj){
      const dates = Object.keys(dataObj).sort();
      let totalWins=0,totalLoss=0, cum=0, peak=0, maxDD=0;
      const dailySeries = [];
      dates.forEach(date=>{
        let dayR=0;
        for(const [k,v] of Object.entries(dataObj[date])){
          if(k==='note' || k==='_events' || k==='screenshot') continue;
          totalWins += v.wins;
          totalLoss += v.losses;
          dayR += (v.wins*2) - (v.losses);
        }
        cum += dayR;
        peak = Math.max(peak, cum);
        maxDD = Math.max(maxDD, peak - cum);
        dailySeries.push({date, value:cum, wins:totalWins, losses:totalLoss});
      });
      const trades = totalWins + totalLoss;
      const netR = (totalWins*2) - totalLoss;
      const exp = trades>0 ? netR/trades : 0;
      return {dates, totalWins, totalLoss, trades, netR, exp, maxDD, dailySeries};
    }

    function aggregateCompounding(dataObj, startUSD, riskPct){
      const a = riskPct/100;
      const dates = Object.keys(dataObj).sort();
      const series = [];
      let P = startUSD;
      let peak = P, maxDD = 0;
      let totalWins=0, totalLoss=0, totalTrades=0;
      let totalPnL = 0;

      dates.forEach(date=>{
        let wins=0, losses=0;
        for(const [k,v] of Object.entries(dataObj[date])){
          if(['note','_events','screenshot'].includes(k)) continue;
          wins += v.wins || 0;
          losses += v.losses || 0;
        }
        const factor = Math.pow(1+2*a, wins) * Math.pow(1-a, losses);
        const prevP = P;
        P = P * factor;
        totalPnL += (P - prevP);
        totalWins += wins; totalLoss += losses;
        totalTrades += wins + losses;

        peak = Math.max(peak, P);
        maxDD = Math.max(maxDD, peak - P);
        series.push({date, value:P, delta:(P-prevP), wins, losses});
      });

      const netUSD = P - startUSD;
      const expUSDperTrade = totalTrades>0 ? totalPnL/totalTrades : 0;
      return {series, current:P, start:startUSD, netUSD, maxDD, totalTrades, totalWins, totalLoss, expUSDperTrade};
    }

    function groupSeries(series, gran, valueKey='value'){
      if(gran==='daily'){
        return {labels: series.map(d=>dispDate(d.date)), values: series.map(d=>d[valueKey])};
      }
      const map={};
      series.forEach(pt=>{
        const key = gran==='weekly' ? weekKey(pt.date) : pt.date.slice(0,7);
        map[key] = pt[valueKey];
      });
      // pretty month labels as YYYY/MM
      const labels = Object.keys(map).map(k=> k.includes('-W') ? k : k.replace('-','/'));
      return {labels, values:Object.values(map)};
    }

    function computeLosingTradeStreaks(dataObj){
      const seq = buildTradeSequence(dataObj).map(x=> x>0 ? 'W':'L');
      const freq = {};
      let cur = 0;
      seq.forEach(out=>{
        if(out==='L'){ cur++; }
        else { if(cur>=2){ freq[cur]=(freq[cur]||0)+1; } cur=0; }
      });
      if(cur>=2){ freq[cur]=(freq[cur]||0)+1; }
      return freq;
    }

    // ========= UI Updates =========
    function renderUnitConfig(){
      const box = $('#unitConfig');
      box.classList.remove('show');
      box.innerHTML = '';
      if(unitMode==='flat'){
        box.classList.add('show');
        box.innerHTML = `
          <div class="row">
            <label>Flat mode:</label>
            <label for="rValue">1R = $</label>
            <input type="number" id="rValue" step="0.01" min="0" style="width:140px">
            <span class="note">Applies to Report & CSV.</span>
          </div>`;
        const el = $('#rValue'); el.value = rValue>0? rValue : '';
        el.onchange = ()=>{
          const v = parseFloat(el.value);
          if(isFinite(v) && v>0){ rValue = v; if(unitMode==='flat') updateReportView(); saveLocal(); }
        };
      } else if(unitMode==='comp'){
        box.classList.add('show');
        box.innerHTML = `
          <div class="row">
            <label>Compounding:</label>
            <label for="compStart">Start $</label>
            <input type="number" id="compStart" step="100" min="0" style="width:160px">
            <label for="compRisk">% Risk per trade</label>
            <input type="number" id="compRisk" step="0.01" min="0" max="100" style="width:140px">
            <span class="note">Exact compounding using wins/losses per day.</span>
          </div>`;
        const s = $('#compStart'), r = $('#compRisk');
        s.value = compStart || ''; r.value = compRiskPct || '';
        s.onchange = ()=>{ const v=parseFloat(s.value); if(isFinite(v) && v>0){ compStart=v; if(unitMode==='comp') updateReportView(); saveLocal(); } };
        r.onchange = ()=>{ const v=parseFloat(r.value); if(isFinite(v) && v>=0 && v<=100){ compRiskPct=v; if(unitMode==='comp') updateReportView(); saveLocal(); } };
      }
    }

    function updateHUD(){
      $('#fileBadge').textContent = currentFileName ? `File: ${currentFileName}` : 'Unsaved';
      $('#dateInput').value = currentDate;
      $('#unitR').classList.toggle('active', unitMode==='R');
      $('#unitDollarFlat').classList.toggle('active', unitMode==='flat');
      $('#unitDollarComp').classList.toggle('active', unitMode==='comp');
      $('#equityTitle').textContent = unitMode==='comp' ? 'Portfolio Value (Compounding)' :
                                      unitMode==='flat' ? 'Cumulative Equity ($)' : 'Cumulative Equity (R)';
      renderUnitConfig();
    }

    function updateBacktestView(){
      updateHUD();

      ensureDay(currentDate);
      $('#dayNote').value = dailyData[currentDate]?.note || '';
      $('#dayNote').oninput = ()=>{
        ensureDay(currentDate);
        dailyData[currentDate].note = $('#dayNote').value.slice(0, 1000);
        saveLocal();
      };

      // aggregates
      let W=0,L=0;
      const dayObj = dailyData[currentDate] || {};
      Object.entries(dayObj).forEach(([k,v])=>{
        if(k==='note' || k==='_events' || k==='screenshot') return;
        W += v.wins; L += v.losses;
      });
      const T = W+L;
      const dayR = (W*2)-L;
      const WR = T>0 ? (W/T*100) : 0;
      const EXP = T>0 ? dayR/T : 0;

      $('#dayLabel').textContent = dispDate(currentDate);
      $('#wins').textContent = W;
      $('#losses').textContent = L;
      $('#total').textContent = T;
      $('#winRate').textContent = `${fmt(WR,1)}%`;
      $('#totalR').textContent = `${fmt(dayR,1)}R`;
      $('#expectancy').textContent = `${fmt(EXP,2)}R`;

      // Today table
      const body = $('#todayTableBody');
      body.innerHTML = '';
      let sumW=0, sumL=0;
      const setupsOnly = Object.keys(dayObj).filter(k=>!['note','_events','screenshot'].includes(k));
      if(setupsOnly.length===0){
        body.innerHTML = `<tr><td colspan="9" class="muted" style="text-align:center">No data for this day yet</td></tr>`;
      } else {
        for(const setup of setupsOnly){
          const v = dayObj[setup];
          const w=v.wins, l=v.losses, t=w+l;
          const r=(w*2)-l, wr=t? (w/t*100):0, exp=t? r/t:0;
          sumW+=w; sumL+=l;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${dispDate(currentDate)}</td>
            <td>${setup}</td>
            <td>${w}</td>
            <td>${l}</td>
            <td>${t}</td>
            <td>${fmt(wr,1)}%</td>
            <td>${fmt(r,1)}R</td>
            <td>${fmt(exp,2)}R</td>
            <td><button class="icon-btn" title="Delete" data-del="${setup}">🗑️</button></td>`;
          body.appendChild(tr);
        }
      }
      const allT = sumW+sumL;
      const allR = (sumW*2)-sumL;
      const allWR = allT? (sumW/allT*100):0;
      const allExp = allT? allR/allT:0;
      $('#sumWins').textContent = sumW;
      $('#sumLosses').textContent = sumL;
      $('#sumTotal').textContent = allT;
      $('#sumWinRate').textContent = `${fmt(allWR,1)}%`;
      $('#sumR').textContent = `${fmt(allR,1)}R`;
      $('#sumExp').textContent = `${fmt(allExp,2)}R`;

      body.querySelectorAll('[data-del]').forEach(btn=>{
        btn.onclick = ()=> deleteEntry(currentDate, btn.getAttribute('data-del'));
      });

      updateScreenshotView();
    }

    function updateScreenshotView(){
      ensureDay(currentDate);
      const dataUrl = dailyData[currentDate].screenshot || null;
      const img = $('#shotImg');
      const tools = $('#shotTools');
      const drop = $('#shotDrop');

      if(dataUrl){
        img.src = dataUrl;
        img.style.display = 'block';
        tools.style.display = 'flex';
        drop.style.display = 'none';
      }else{
        img.removeAttribute('src');
        img.style.display = 'none';
        tools.style.display = 'none';
        drop.style.display = 'flex';
      }
    }

    function updateReportView(){
      updateHUD();
      const data = filteredData();

      // Trades & WR for summary
      const aggR = aggregateR(data);
      const dates = Object.keys(data).sort();

      if(unitMode==='comp'){
        const start = compStart>0 ? compStart : 100000;
        const risk = compRiskPct>0 ? compRiskPct : 0.3;
        const comp = aggregateCompounding(data, start, risk);

        // KPIs
        $('#kpiTrades').textContent = comp.totalTrades;
        $('#kpiNet').textContent = `$${fmt(comp.netUSD,2)}`;
        const winRate = comp.totalTrades? (comp.totalWins/comp.totalTrades*100):0;
        $('#kpiWR').textContent = `${fmt(winRate,1)}%`;
        $('#kpiExp').textContent = `$${fmt(comp.expUSDperTrade,2)}`;
        $('#kpiDD').textContent = `$${fmt(comp.maxDD,2)}`;

        // Spans + Avg trades/day
        if(dates.length>0){
          const minD = new Date(dates[0]);
          const maxD = new Date(dates[dates.length-1]);
          const daySpan = Math.floor((maxD - minD)/86400000) + 1;
          const months = new Set(dates.map(d=>d.slice(0,7)));
          const quarters = new Set(dates.map(d=>quarterKey(d)));
          const years = new Set(dates.map(d=>new Date(d).getFullYear()));
          const activeDays = dates.length;
          const avgPerDay = activeDays>0 ? comp.totalTrades/activeDays : 0;

          $('#kpiDaySpan').textContent = daySpan;
          $('#kpiMonthSpan').textContent = months.size;
          $('#kpiQuarterSpan').textContent = quarters.size;
          $('#kpiYearSpan').textContent = years.size;
          $('#kpiAvgPerDay').textContent = fmt(avgPerDay,2);
        }else{
          $('#kpiDaySpan').textContent = 0;
          $('#kpiMonthSpan').textContent = 0;
          $('#kpiQuarterSpan').textContent = 0;
          $('#kpiYearSpan').textContent = 0;
          $('#kpiAvgPerDay').textContent = '0.00';
        }

        // Chart
        const ctx = $('#equityChart')?.getContext('2d');
        if(ctx && !equityChart){
          equityChart = new Chart(ctx,{
            type:'line',
            data:{labels:[], datasets:[{label:'Portfolio Value ($)', data:[], fill:true, tension:.15, borderWidth:2}]},
            options:{
              responsive:true, maintainAspectRatio:false,
              scales:{ x:{grid:{color:'#2b315d'}}, y:{grid:{color:'#2b315d'}, ticks:{callback:(v)=> `$${fmt(v,0)}`}}},
              plugins:{ legend:{labels:{color:'#cfd2e6'}}, tooltip:{callbacks:{label:(ctx)=>`$${fmt(ctx.parsed.y,2)}`}} }
            }
          });
        }
        if(equityChart){
          const grouped = groupSeries(comp.series, granularity, 'value');
          equityChart.data.labels = grouped.labels;
          equityChart.data.datasets[0].data = grouped.values;
          const perf = comp.netUSD;
          const color = perf>0?'#27be69':(perf<0?'#ff5a6b':'#ffc857');
          equityChart.data.datasets[0].borderColor = color;
          equityChart.data.datasets[0].backgroundColor = color+'22';
          equityChart.data.datasets[0].label = 'Portfolio Value ($)';
          equityChart.update();
        }
        $('#startEquity').textContent = `$${fmt(comp.start,2)}`;
        $('#currEquity').textContent = `$${fmt(comp.current,2)}`;
        $('#peakEquity').textContent = `$${fmt(Math.max(...comp.series.map(s=>s.value), comp.start),2)}`;
        $('#chartDD').textContent = `$${fmt(comp.maxDD,2)}`;

        // Setup cards (rough $ display using starting risk per R)
        const container = $('#setupCards');
        container.innerHTML='';
        const statsBySetup = {}; SETUPS.forEach(s=> statsBySetup[s]={wins:0, losses:0});
        for(const d of Object.keys(data)){
          for(const [k,v] of Object.entries(data[d])){
            if(['note','_events','screenshot'].includes(k)) continue;
            if(!statsBySetup[k]) statsBySetup[k]={wins:0, losses:0};
            statsBySetup[k].wins += v.wins; statsBySetup[k].losses += v.losses;
          }
        }
        SETUPS.forEach(s=>{
          const st = statsBySetup[s] || {wins:0, losses:0};
          const t = st.wins+st.losses; if(t===0) return;
          const r = (st.wins*2)-st.losses;
          const wr = t? (st.wins/t*100):0;
          const expR = t? (r/t):0;
          const card = document.createElement('div');
          card.className='kpi';
          card.innerHTML = `
            <div class="label">${s}</div>
            <div class="value">$${fmt(r * (compStart * (compRiskPct/100)),2)}</div>
            <div class="muted" style="margin-top:6px">Trades: <b>${t}</b> • Win%: <b>${fmt(wr,1)}%</b> • Exp (R): <b>${fmt(expR,2)}R</b></div>`;
          container.appendChild(card);
        });
        if(container.children.length===0){ container.innerHTML = `<div class="muted">No setup data in the selected range.</div>`; }

        // Daily outcomes (counted by R sign)
        let win=0, lose=0, be=0;
        dates.forEach(d=>{
          let dr=0;
          for(const [k,v] of Object.entries(data[d])){
            if(['note','_events','screenshot'].includes(k)) continue;
            dr += (v.wins*2) - v.losses;
          }
          if(dr>0) win++; else if(dr<0) lose++; else be++;
        });
        const totalDays = dates.length || 1;
        $('#winDays').textContent = `${win} (${fmt(win/totalDays*100,1)}%)`;
        $('#loseDays').textContent = `${lose} (${fmt(lose/totalDays*100,1)}%)`;
        $('#beDays').textContent = `${be} (${fmt(be/totalDays*100,1)}%)`;

        // Periodic averages ($)
        const dailyPnL = comp.series.map(s=>s.delta);
        const daysSet = dates;
        const totalPnL = dailyPnL.reduce((a,b)=>a+b,0);
        const weeks = new Set(daysSet.map(d=>weekKey(d)));
        const months = new Set(daysSet.map(d=>d.slice(0,7)));
        const dAvg = daysSet.length? totalPnL/daysSet.length : 0;
        const wAvg = weeks.size? totalPnL/weeks.size : 0;
        const mAvg = months.size? totalPnL/months.size : 0;
        $('#avgDaily').textContent = `$${fmt(dAvg,2)}`;
        $('#avgWeekly').textContent = `$${fmt(wAvg,2)}`;
        $('#avgMonthly').textContent = `$${fmt(mAvg,2)}`;

      } else {
        // ---- R or flat $ (linear) path ----
        $('#kpiTrades').textContent = aggR.trades;
        const netDisp = unitMode==='flat' ? `$${fmt(aggR.netR * rValue,2)}` : `${fmt(aggR.netR,2)}R`;
        const expDisp = unitMode==='flat' ? `$${fmt(aggR.exp * rValue,2)}` : `${fmt(aggR.exp,2)}R`;
        const ddDisp = unitMode==='flat' ? `$${fmt(aggR.maxDD * rValue,2)}` : `${fmt(aggR.maxDD,2)}R`;
        $('#kpiNet').textContent = netDisp;
        $('#kpiWR').textContent = `${fmt(aggR.trades? (aggR.totalWins/aggR.trades*100):0,1)}%`;
        $('#kpiExp').textContent = expDisp;
        $('#kpiDD').textContent = ddDisp;

        // Spans + Avg trades/day
        if(dates.length>0){
          const minD = new Date(dates[0]);
          const maxD = new Date(dates[dates.length-1]);
          const daySpan = Math.floor((maxD - minD)/86400000) + 1;
          const months = new Set(dates.map(d=>d.slice(0,7)));
          const quarters = new Set(dates.map(d=>quarterKey(d)));
          const years = new Set(dates.map(d=>new Date(d).getFullYear()));
          const activeDays = dates.length;
          const avgPerDay = activeDays>0 ? aggR.trades/activeDays : 0;

          $('#kpiDaySpan').textContent = daySpan;
          $('#kpiMonthSpan').textContent = months.size;
          $('#kpiQuarterSpan').textContent = quarters.size;
          $('#kpiYearSpan').textContent = years.size;
          $('#kpiAvgPerDay').textContent = fmt(avgPerDay,2);
        }else{
          $('#kpiDaySpan').textContent = 0;
          $('#kpiMonthSpan').textContent = 0;
          $('#kpiQuarterSpan').textContent = 0;
          $('#kpiYearSpan').textContent = 0;
          $('#kpiAvgPerDay').textContent = '0.00';
        }

        // Chart
        const ctx = $('#equityChart')?.getContext('2d');
        if(ctx && !equityChart){
          equityChart = new Chart(ctx,{
            type:'line',
            data:{labels:[], datasets:[{label:'Cumulative Equity', data:[], fill:true, tension:.15, borderWidth:2}]},
            options:{
              responsive:true, maintainAspectRatio:false,
              scales:{ x:{grid:{color:'#2b315d'}}, y:{grid:{color:'#2b315d'}, ticks:{callback:(v)=> unitMode==='flat'? `$${fmt(v,0)}` : `${v}R`}}},
              plugins:{ legend:{labels:{color:'#cfd2e6'}}, tooltip:{callbacks:{label:(ctx)=> unitMode==='flat'? `$${fmt(ctx.parsed.y,2)}` : `${fmt(ctx.parsed.y,2)}R` }} }
            }
          });
        }
        if(equityChart){
          const grouped = groupSeries(aggR.dailySeries, granularity, 'value');
          const vals = unitMode==='flat' ? grouped.values.map(v=> v*rValue) : grouped.values;
          equityChart.data.labels = grouped.labels;
          equityChart.data.datasets[0].data = vals;
          const color = aggR.netR>0?'#27be69':(aggR.netR<0?'#ff5a6b':'#ffc857');
          equityChart.data.datasets[0].borderColor = color;
          equityChart.data.datasets[0].backgroundColor = color+'22';
          equityChart.data.datasets[0].label = unitMode==='flat' ? 'Cumulative Equity ($)' : 'Cumulative Equity (R)';
          equityChart.update();
        }
        $('#startEquity').textContent = unitMode==='flat' ? `$${fmt(0,2)}` : `${fmt(0,2)}R`;
        const totalEquity = aggR.dailySeries.length? aggR.dailySeries[aggR.dailySeries.length-1].value : 0;
        const peak = (()=>{ let p=0; aggR.dailySeries.forEach(pt=>{ p=Math.max(p,pt.value); }); return p; })();
        $('#currEquity').textContent = unitMode==='flat' ? `$${fmt(totalEquity*rValue,2)}` : `${fmt(totalEquity,2)}R`;
        $('#peakEquity').textContent = unitMode==='flat' ? `$${fmt(peak*rValue,2)}` : `${fmt(peak,2)}R`;
        $('#chartDD').textContent = unitMode==='flat' ? `$${fmt(aggR.maxDD*rValue,2)}` : `${fmt(aggR.maxDD,2)}R`;

        // Setup cards
        const container = $('#setupCards');
        container.innerHTML='';
        const statsBySetup = {}; SETUPS.forEach(s=> statsBySetup[s]={wins:0, losses:0});
        for(const d of Object.keys(data)){
          for(const [k,v] of Object.entries(data[d])){
            if(['note','_events','screenshot'].includes(k)) continue;
            if(!statsBySetup[k]) statsBySetup[k]={wins:0, losses:0};
            statsBySetup[k].wins += v.wins; statsBySetup[k].losses += v.losses;
          }
        }
        SETUPS.forEach(s=>{
          const st = statsBySetup[s] || {wins:0, losses:0};
          const t = st.wins+st.losses; if(t===0) return;
          const r = (st.wins*2)-st.losses;
          const wr = t? (st.wins/t*100):0;
          const exp = t? (r/t):0;
          const valueMain = unitMode==='flat' ? `$${fmt(r*rValue,2)}` : `${fmt(r,2)}R`;
          const card = document.createElement('div');
          card.className='kpi';
          card.innerHTML = `
            <div class="label">${s}</div>
            <div class="value">${valueMain}</div>
            <div class="muted" style="margin-top:6px">Trades: <b>${t}</b> • Win%: <b>${fmt(wr,1)}%</b> • Exp: <b>${unitMode==='flat'? `$${fmt(exp*rValue,2)}` : `${fmt(exp,2)}R`}</b></div>`;
          container.appendChild(card);
        });
        if(container.children.length===0){ container.innerHTML = `<div class="muted">No setup data in the selected range.</div>`; }

        // Daily outcomes & periodic averages (linear)
        let win=0, lose=0, be=0;
        dates.forEach(d=>{
          let dr=0;
          for(const [k,v] of Object.entries(data[d])){
            if(['note','_events','screenshot'].includes(k)) continue;
            dr += (v.wins*2) - v.losses;
          }
          if(dr>0) win++; else if(dr<0) lose++; else be++;
        });
        const totalDays = dates.length || 1;
        $('#winDays').textContent = `${win} (${fmt(win/totalDays*100,1)}%)`;
        $('#loseDays').textContent = `${lose} (${fmt(lose/totalDays*100,1)}%)`;
        $('#beDays').textContent = `${be} (${fmt(be/totalDays*100,1)}%)`;

        let totalR=0, weeks=new Set(), months=new Set();
        dates.forEach(d=>{
          let dr=0;
          for(const [k,v] of Object.entries(data[d])){ if(!['note','_events','screenshot'].includes(k)) dr += (v.wins*2)-v.losses; }
          totalR += dr;
          weeks.add(weekKey(d)); months.add(d.slice(0,7));
        });
        const dAvg = dates.length? totalR/dates.length : 0;
        const wAvg = weeks.size? totalR/weeks.size : 0;
        const mAvg = months.size? totalR/months.size : 0;
        $('#avgDaily').textContent = unitMode==='flat' ? `$${fmt(dAvg*rValue,2)}` : `${fmt(dAvg,2)}R`;
        $('#avgWeekly').textContent = unitMode==='flat' ? `$${fmt(wAvg*rValue,2)}` : `${fmt(wAvg,2)}R`;
        $('#avgMonthly').textContent = unitMode==='flat' ? `$${fmt(mAvg*rValue,2)}` : `${fmt(mAvg,2)}R`;
      }

      // Losing streaks by TRADES
      const tbody = $('#streakBody'); tbody.innerHTML='';
      const freq = computeLosingTradeStreaks(data);
      const keys = Object.keys(freq).map(n=>+n).sort((a,b)=>a-b);
      if(keys.length===0){
        tbody.innerHTML = `<tr><td colspan="2" class="muted" style="text-align:center">No losing streaks of 2+ trades</td></tr>`;
      }else{
        keys.forEach(k=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${k}</td><td>${freq[k]}</td>`;
          tbody.appendChild(tr);
        });
      }

      // Monthly table (R math, show labels prettier)
      const mBody = $('#monthlyBody'); mBody.innerHTML='';
      const monthly = {};
      Object.keys(data).sort().forEach(d=>{
        const m = d.slice(0,7);
        if(!monthly[m]) monthly[m]={wins:0, losses:0, cum:0, peak:0, dd:0};
        let dr=0;
        for(const [k,v] of Object.entries(data[d])){
          if(!['note','_events','screenshot'].includes(k)){ monthly[m].wins+=v.wins; monthly[m].losses+=v.losses; dr += (v.wins*2)-v.losses; }
        }
        monthly[m].cum += dr;
        monthly[m].peak = Math.max(monthly[m].peak, monthly[m].cum);
        monthly[m].dd = Math.max(monthly[m].dd, monthly[m].peak - monthly[m].cum);
      });
      const monthsKeys = Object.keys(monthly).sort();
      if(monthsKeys.length===0){
        mBody.innerHTML = `<tr><td colspan="6" class="muted" style="text-align:center">No data</td></tr>`;
      }else{
        monthsKeys.forEach(m=>{
          const x = monthly[m];
          const trades = x.wins + x.losses;
          const net = (x.wins*2)-x.losses;
          const wr = trades? (x.wins/trades*100):0;
          const exp = trades? (net/trades) : 0;
          const netDisp = unitMode==='flat' ? `$${fmt(net*rValue,2)}` : `${fmt(net,2)}R`;
          const expDisp = unitMode==='flat' ? `$${fmt(exp*rValue,2)}` : `${fmt(exp,2)}R`;
          const ddDisp = unitMode==='flat' ? `$${fmt(x.dd*rValue,2)}` : `${fmt(x.dd,2)}R`;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${m.replace('-','/')}</td>
            <td>${trades}</td>
            <td style="color:${net>0?'var(--green)':net<0?'var(--red)':'var(--amber)'}">${netDisp}</td>
            <td>${fmt(wr,1)}%</td>
            <td style="color:${exp>0?'var(--green)':exp<0?'var(--red)':'var(--amber)'}">${expDisp}</td>
            <td style="color:var(--red)">${ddDisp}</td>`;
          mBody.appendChild(tr);
        });
      }
    }

    // ========= File I/O =========
    function saveToFile(){
      const name = prompt('Save as (file name, no extension):', currentFileName || 'backtest');
      if(!name) return;
      if(Object.keys(dailyData).length===0){ alert('No data to save'); return; }
      const saveData = { fileName:name, data:dailyData, currentDate, savedAt:new Date().toISOString(), version:'3.1' };
      const blob = new Blob([JSON.stringify(saveData,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${name.replace(/[^a-z0-9]/gi,'_')}_backtest.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      currentFileName = name; saveLocal();
      showToast(`Saved “${name}”`);
    }
    function loadFromFile(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const loaded = JSON.parse(e.target.result);
          if(!loaded.data || !loaded.fileName) { alert('Invalid file format'); return; }
          if(Object.keys(dailyData).length>0){
            if(!confirm('Loading will replace current data. Continue?')) return;
          }
          dailyData = loaded.data;
          Object.keys(dailyData).forEach(d=>{
            if(!dailyData[d]._events) dailyData[d]._events=[];
            if(dailyData[d].note===undefined) dailyData[d].note='';
          });
          currentFileName = loaded.fileName;
          if(loaded.currentDate) currentDate = loaded.currentDate;
          saveLocal();
          updateBacktestView(); updateReportView();
          showToast(`Loaded “${currentFileName}”`);
        }catch(err){ alert('Failed to read file'); }
      };
      reader.readAsText(file);
    }
    function exportCSV(){
      if(Object.keys(dailyData).length===0){ alert('No data to export'); return; }
      let csv = 'Date,Setup,Wins,Losses,Total Trades,Win Rate (%),Total R,Expectancy R,Note\n';
      const dates = Object.keys(dailyData).sort();
      let allW=0, allL=0;
      dates.forEach(date=>{
        const note = (dailyData[date].note || '').replace(/[\n\r,]/g,' ');
        for(const [setup,v] of Object.entries(dailyData[date])){
          if(['note','_events','screenshot'].includes(setup)) continue;
          const w=v.wins, l=v.losses, t=w+l, r=(w*2)-l, wr=t? (w/t*100):0, exp=t? r/t:0;
          allW+=w; allL+=l;
          csv += `${dispDate(date)},${setup},${w},${l},${t},${fmt(wr,1)},${fmt(r,1)},${fmt(exp,2)},${note}\n`;
        }
      });
      const t=allW+allL, r=(allW*2)-allL, wr=t? (allW/t*100):0, exp=t? r/t:0;
      csv += `\nTOTAL,ALL,${allW},${allL},${t},${fmt(wr,1)},${fmt(r,1)},${fmt(exp,2)},\n`;
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a');
      const fname = (currentFileName? currentFileName.replace(/[^a-z0-9]/gi,'_') : 'trading_backtest') + `_results_${new Date().toISOString().slice(0,10).replaceAll('-','_')}.csv`;
      a.href=url; a.download=fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showToast('CSV exported');
    }

    // ========= Screenshot handling (PASTE-ONLY) =========
    function fileToDataURL(fileOrBlob, cb){
      const reader = new FileReader();
      reader.onload = ()=> cb(reader.result);
      reader.readAsDataURL(fileOrBlob);
    }
    function wireScreenshot(){
      const drop = $('#shotDrop');
      drop.addEventListener('click', ()=> drop.focus());
      ['focus','blur','dragenter','dragleave'].forEach(ev=>{
        drop.addEventListener(ev, ()=>{
          if(ev==='focus' || ev==='dragenter') drop.classList.add('focus');
          else drop.classList.remove('focus');
        });
      });
      drop.addEventListener('dragover', (e)=>{ e.preventDefault(); });
      drop.addEventListener('drop', (e)=>{
        e.preventDefault();
        const file = e.dataTransfer.files?.[0];
        if(!file) return;
        if(!file.type.startsWith('image/')) return alert('Drop an image file.');
        fileToDataURL(file, (dataUrl)=>{
          ensureDay(currentDate);
          dailyData[currentDate].screenshot = dataUrl;
          updateScreenshotView();
          saveLocal();
          showToast('Screenshot added');
        });
      });
      drop.addEventListener('paste', (e)=>{
        const items = e.clipboardData && e.clipboardData.items;
        if(!items) return;
        for(const it of items){
          if(it.type && it.type.indexOf('image') !== -1){
            const file = it.getAsFile();
            if(!file) continue;
            fileToDataURL(file, (dataUrl)=>{
              ensureDay(currentDate);
              dailyData[currentDate].screenshot = dataUrl;
              updateScreenshotView();
              saveLocal();
              showToast('Screenshot pasted');
            });
            e.preventDefault();
            return;
          }
        }
        alert('Clipboard has no image. Copy an image first, then paste.');
      });
      $('#openShot').onclick = ()=>{
        const dataUrl = dailyData[currentDate]?.screenshot;
        if(!dataUrl) return;
        const w = window.open();
        if(w){ w.document.write(`<img src="${dataUrl}" style="max-width:100%; height:auto">`); }
      };
      $('#clearShot').onclick = ()=>{
        if(!dailyData[currentDate]?.screenshot) return;
        const snap = dailyData[currentDate].screenshot;
        pushUndo(()=>{
          ensureDay(currentDate);
          dailyData[currentDate].screenshot = snap;
          updateScreenshotView(); saveLocal();
        });
        delete dailyData[currentDate].screenshot;
        updateScreenshotView(); saveLocal();
        showToast('Screenshot cleared');
      };
    }

    // ========= Analytics Worker =========
    function makeWorker(){
      const src = `
        let rngState = 123456789;
        function setSeed(s){ rngState = (s>>>0) || 123456789; }
        function rand(){ rngState ^= rngState << 13; rngState ^= rngState >>> 17; rngState ^= rngState << 5; return ((rngState>>>0) / 4294967296); }
        function quantile(sorted, q){
          if(sorted.length===0) return 0;
          const pos = (sorted.length-1)*q;
          const base = Math.floor(pos);
          const rest = pos-base;
          return sorted[base] + (sorted[base+1] - sorted[base] || 0)*rest;
        }
        function wilson(wins, n, z=1.96){
          if(n===0) return [0,0];
          const p = wins/n;
          const denom = 1 + (z*z)/n;
          const center = (p + (z*z)/(2*n)) / denom;
          const margin = (z*Math.sqrt((p*(1-p))/n + (z*z)/(4*n*n))) / denom;
          return [Math.max(0, center - margin), Math.min(1, center + margin)];
        }
        function blockBootstrapMeans(seq, n, resamples, blockSize){
          const N = seq.length;
          if(N===0) return [];
          const useBlocks = blockSize>1 && N>=blockSize;
          const out = new Float64Array(resamples);
          for(let r=0; r<resamples; r++){
            let total=0, k=0;
            if(useBlocks){
              while(k<n){
                const start = Math.floor(rand()*N);
                for(let b=0;b<blockSize && k<n;b++){
                  total += seq[(start+b)%N];
                  k++;
                }
              }
            }else{
              for(k=0;k<n;k++){ total += seq[Math.floor(rand()*N)]; }
            }
            out[r] = total/n;
          }
          return out;
        }
        function mcSim(outcomes, horizon, sims, blockSize, postProgress){
          const N = outcomes.length;
          const useBlocks = blockSize>1 && N>=blockSize;
          const finals = new Float64Array(sims);
          const maxDDs = new Float64Array(sims);
          const fan = Array.from({length:horizon}, ()=> new Float64Array(sims));
          for(let s=0; s<sims; s++){
            let eq=0, peak=0;
            let t=0;
            if(useBlocks){
              while(t<horizon){
                const start = Math.floor(rand()*N);
                for(let b=0;b<blockSize && t<horizon;b++){
                  eq += outcomes[(start+b)%N];
                  peak = Math.max(peak, eq);
                  const dd = peak - eq;
                  if(dd>maxDDs[s]) maxDDs[s] = dd;
                  fan[t][s] = eq;
                  t++;
                }
              }
            }else{
              for(t=0;t<horizon;t++){
                eq += outcomes[Math.floor(rand()*N)];
                peak = Math.max(peak, eq);
                const dd = peak - eq;
                if(dd>maxDDs[s]) maxDDs[s] = dd;
                fan[t][s] = eq;
              }
            }
            finals[s] = eq;
            if(s % 200 === 0) postProgress(s+1, sims);
          }
          return {finals, maxDDs, fan};
        }

        self.onmessage = (e)=>{
          const {type, payload} = e.data;
          if(type==='run'){
            const {seq, wins, trades, resamples, sims, horizon, block, seed} = payload;
            if(seed!==undefined && seed!==null) { rngState = (seed>>>0) || 123456789; }
            const post = (done,total)=> self.postMessage({type:'progress', done, total});

            const bootMeans = blockBootstrapMeans(seq, trades, resamples, block);
            const sortedBoot = Array.from(bootMeans).sort((a,b)=>a-b);
            const expMean = trades>0 ? seq.reduce((a,b)=>a+b,0)/seq.length : 0;
            const expCI = [quantile(sortedBoot, 0.025), quantile(sortedBoot, 0.975)];
            const wil = wilson(wins, trades);

            const mc = mcSim(seq, horizon, sims, block, post);
            const finals = Array.from(mc.finals).sort((a,b)=>a-b);
            const dds = Array.from(mc.maxDDs).sort((a,b)=>a-b);

            const q5=[], q50=[], q95=[];
            for(let t=0;t<horizon;t++){
              const arr = Array.from(mc.fan[t]).sort((a,b)=>a-b);
              const pos = (arr.length-1)*0.5; // minor micro-opt
              q5.push(arr[Math.floor((arr.length-1)*0.05)]);
              q50.push(arr[Math.floor(pos)]);
              q95.push(arr[Math.floor((arr.length-1)*0.95)]);
            }

            self.postMessage({type:'done', result:{ expMean, expCI, wil, finals, dds, q5, q50, q95 }});
          }
        };
      `;
      const blob = new Blob([src], {type:'application/javascript'});
      const url = URL.createObjectURL(blob);
      const w = new Worker(url);
      URL.revokeObjectURL(url);
      return w;
    }

    // ========= Analytics UI =========
    function anaSetStatus(txt){ $('#anaStatus').textContent = txt || ''; }
    function anaSetProgress(done,total){
      const pct = total? Math.floor(done/total*100) : 0;
      $('#anaProg').style.width = pct+'%';
    }
    function quantileFromSorted(arr, q){
      if(arr.length===0) return 0;
      const pos = (arr.length-1)*q;
      const base = Math.floor(pos);
      const rest = pos-base;
      return arr[base] + (arr[base+1]-arr[base]||0)*rest;
    }

    function runAnalytics(){
      const useFilter = $('#anaUseFilter').checked;
      const data = useFilter ? filteredData() : dailyData;

      const outcomes = getTradeOutcomes(data);
      const seq = buildTradeSequence(data); // for block sampling
      const trades = outcomes.length;
      if(trades<2){ alert('Need at least 2 trades to run analytics.'); return; }

      const horizon = Math.max(1, parseInt($('#anaHorizon').value||trades,10));
      const sims = Math.max(100, parseInt($('#anaSims').value||10000,10));
      const resamples = Math.max(100, parseInt($('#anaBoot').value||10000,10));
      const block = Math.max(1, parseInt($('#anaBlock').value||1,10));
      const seed = $('#anaSeed').value==='' ? null : parseInt($('#anaSeed').value,10);

      const keyObj = {useFilter, horizon, sims, resamples, block, seed, tradesHash: trades, wins: outcomes.filter(x=>x>0).length, losses: outcomes.filter(x=>x<0).length};
      const key = JSON.stringify(keyObj);
      if(anaCacheKey === key){
        anaSetStatus('Using cached results (same params).');
        return;
      }
      anaCacheKey = key;

      if(!anaWorker){
        anaWorker = makeWorker();
        anaWorker.onmessage = (e)=>{
          const {type, result, done, total} = e.data;
          if(type==='progress'){ anaSetProgress(done,total); return; }
          if(type==='done'){
            anaSetProgress(100,100);
            renderAnalytics(result, trades, outcomes.filter(x=>x>0).length);
            anaSetStatus('Done.');
          }
        };
      }

      $('#anaMeta').textContent = `nTrades=${trades}, horizon=${horizon}, sims=${sims}, resamples=${resamples}, block=${block}, seed=${seed ?? '—'}`;
      anaSetStatus('Running…');
      anaSetProgress(0,1);
      anaWorker.postMessage({type:'run', payload:{ seq, wins: outcomes.filter(x=>x>0).length, trades, resamples, sims, horizon, block, seed }});
    }

    function renderAnalytics(res, trades, wins){
      const mean = res.expMean;
      const [lo,hi] = res.expCI;
      $('#ciExp').textContent = `${fmt(mean,3)}  [${fmt(lo,3)}, ${fmt(hi,3)}]`;
      const p = trades? (wins/trades) : 0;
      const [wlo, whi] = res.wil;
      $('#ciWR').textContent = `Win Rate: ${fmt(p*100,2)}%  [${fmt(wlo*100,2)}%, ${fmt(whi*100,2)}%]`;

      // Bootstrap schematic line
      if(anaBootChart){ anaBootChart.destroy(); }
      anaBootChart = new Chart($('#bootChart'), {
        type:'line',
        data:{ labels: ['lo','q25','mean','q75','hi'], datasets:[{label:'Bootstrap', data:[lo,(lo+mean)/2,mean,(hi+mean)/2,hi], fill:false, borderWidth:2}] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      });

      // Fan chart
      if(mcFanChart) mcFanChart.destroy();
      mcFanChart = new Chart($('#mcFan'), {
        type:'line',
        data:{
          labels: Array.from({length: res.q50.length}, (_,i)=> i+1),
          datasets:[
            {label:'P95', data: res.q95, borderColor:'#9bd5ff', backgroundColor:'#9bd5ff33', fill:'+1', tension:.15},
            {label:'P50', data: res.q50, borderColor:'#4ea1ff', backgroundColor:'#4ea1ff00', fill:false, tension:.15, borderWidth:2},
            {label:'P05', data: res.q5, borderColor:'#9bd5ff', backgroundColor:'#9bd5ff33', fill:'-1', tension:.15}
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{legend:{labels:{color:'#cfd2e6'}}},
          scales:{ x:{grid:{color:'#2b315d'}, title:{display:true, text:'Trade #', color:'#cfd2e6'}}, y:{grid:{color:'#2b315d'}, title:{display:true, text:'Cumulative R', color:'#cfd2e6'}}}
        }
      });

      // Final outcomes histogram
      const finals = res.finals;
      const fmin = finals[0], fmax = finals[finals.length-1];
      const fBins = 30;
      const step = (fmax-fmin)/fBins || 1;
      const centers = []; const counts = new Array(fBins).fill(0);
      for(let i=0;i<fBins;i++){ centers.push(fmin + (i+0.5)*step); }
      finals.forEach(v=>{
        let idx = Math.floor((v - fmin)/step); idx = clamp(idx,0,fBins-1);
        counts[idx]++;
      });
      if(mcFinalHistChart) mcFinalHistChart.destroy();
      mcFinalHistChart = new Chart($('#mcFinalHist'), {
        type:'bar', data:{ labels: centers.map(v=> fmt(v,0)), datasets:[{label:'Final R', data: counts}] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      });

      // Drawdown histogram
      const dds = res.dds;
      const dmin = dds[0], dmax = dds[dds.length-1];
      const dBins = 30;
      const dStep = (dmax-dmin)/dBins || 1;
      const dCenters = []; const dCounts = new Array(dBins).fill(0);
      for(let i=0;i<dBins;i++){ dCenters.push(dmin + (i+0.5)*dStep); }
      dds.forEach(v=>{
        let idx = Math.floor((v - dmin)/dStep); idx = clamp(idx,0,dBins-1);
        dCounts[idx]++;
      });
      if(mcDDHistChart) mcDDHistChart.destroy();
      mcDDHistChart = new Chart($('#mcDDHist'), {
        type:'bar', data:{ labels: dCenters.map(v=> fmt(v,0)), datasets:[{label:'Max DD (R)', data: dCounts}] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      });

      const meanFinal = finals.reduce((a,b)=>a+b,0)/finals.length;
      const medFinal = quantileFromSorted(finals, 0.5);
      const lo90 = quantileFromSorted(finals, 0.05);
      const hi90 = quantileFromSorted(finals, 0.95);
      const avgDD = dds.reduce((a,b)=>a+b,0)/dds.length;
      const loDD = quantileFromSorted(dds, 0.05);
      const hiDD = quantileFromSorted(dds, 0.95);
      const negProb = finals.filter(v=>v<0).length / finals.length;

      $('#mcMean').textContent = `${fmt(meanFinal,1)} R`;
      $('#mcRange').textContent = `${fmt(lo90,1)} R  →  ${fmt(hi90,1)} R`;
      $('#mcMedian').textContent = `${fmt(medFinal,1)} R`;
      $('#mcAvgDD').textContent = `${fmt(avgDD,1)} R`;
      $('#mcDDRange').textContent = `${fmt(loDD,1)} R  →  ${fmt(hiDD,1)} R`;
      $('#mcNegProb').textContent = `${fmt(negProb*100,2)}%`;
    }

    // ========= Events =========
    function wireEvents(){
      // Tabs
      $('#tabBtn-backtest').onclick = ()=>{ switchTab('backtest'); };
      $('#tabBtn-report').onclick = ()=>{ switchTab('report'); };
      $('#tabBtn-analytics').onclick = ()=>{ switchTab('analytics'); };

      // Date
      $('#dateInput').onchange = ()=> setDate($('#dateInput').value||currentDate);
      $('#prevDay').onclick = ()=> changeDate(-1);
      $('#nextDay').onclick = ()=> changeDate(1);
      $('#todayBtn').onclick = ()=> setDate(new Date().toISOString().slice(0,10));

      // Setup
      document.querySelectorAll('[data-setup]').forEach(btn=>{
        btn.onclick = ()=>{
          document.querySelectorAll('[data-setup]').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active'); currentSetup = btn.getAttribute('data-setup');
          saveLocal();
        };
      });
      // Win/Lose
      $('#winBtn').onclick = ()=> record('win');
      $('#loseBtn').onclick = ()=> record('lose');

      // Units
      $('#unitR').onclick = ()=>{ unitMode='R'; updateReportView(); saveLocal(); };
      $('#unitDollarFlat').onclick = ()=>{ unitMode='flat'; updateReportView(); saveLocal(); };
      $('#unitDollarComp').onclick = ()=>{ unitMode='comp'; updateReportView(); saveLocal(); };

      // File actions
      $('#saveBtn').onclick = saveToFile;
      $('#loadBtn').onclick = ()=> $('#loadInput').click();
      $('#loadInput').onchange = (e)=> {
        const f = e.target.files && e.target.files[0];
        if(f) loadFromFile(f);
        e.target.value = '';
      };
      $('#exportBtn').onclick = exportCSV;

      // Report filters
      $('#applyRange').onclick = ()=>{
        const s = $('#startDate').value;
        const e = $('#endDate').value;
        if(!s || !e){ alert('Select both start and end dates.'); return; }
        if(s>e){ alert('Start must be before end.'); return; }
        reportStartDate = s; reportEndDate = e;
        updateReportView(); saveLocal();
      };
      $('#clearRangeBtn').onclick = ()=>{
        reportStartDate = null; reportEndDate = null;
        $('#startDate').value=''; $('#endDate').value='';
        updateReportView(); saveLocal();
      };

      // Granularity
      $$('#granSeg button').forEach(b=>{
        b.onclick = ()=>{
          $$('#granSeg button').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          granularity = b.getAttribute('data-gran');
          updateReportView(); saveLocal();
        };
      });

      // Reset buttons
      $('#resetDayBtn').onclick = resetDay;
      $('#resetAllBtn').onclick = resetAll;

      // Analytics
      $('#anaRun').onclick = runAnalytics;
      $('#anaClear').onclick = ()=>{
        anaCacheKey = null;
        $('#anaProg').style.width='0%';
        $('#anaStatus').textContent = '';
        $('#anaMeta').textContent = '—';
        if(anaBootChart) { anaBootChart.destroy(); anaBootChart=null; }
        if(mcFanChart) { mcFanChart.destroy(); mcFanChart=null; }
        if(mcFinalHistChart) { mcFinalHistChart.destroy(); mcFinalHistChart=null; }
        if(mcDDHistChart) { mcDDHistChart.destroy(); mcDDHistChart=null; }
        $('#ciExp').textContent = '—';
        $('#ciWR').textContent = '—';
        $('#mcMean').textContent = '—';
        $('#mcRange').textContent = '—';
        $('#mcMedian').textContent = '—';
        $('#mcAvgDD').textContent = '—';
        $('#mcDDRange').textContent = '—';
        $('#mcNegProb').textContent = '—';
      };

      // Keyboard shortcuts
      document.addEventListener('keydown', (e)=>{
        if(isInputFocused()) return;

        if(e.key==='ArrowLeft'){ e.preventDefault(); changeDate(-1); return; }
        if(e.key==='ArrowRight'){ e.preventDefault(); changeDate(1); return; }

        if(e.key==='ArrowUp'){ e.preventDefault(); record('win'); return; }
        if(e.key==='ArrowDown'){ e.preventDefault(); record('lose'); return; }

        if(e.key==='1' || e.key==='2' || e.key==='3'){
          const idx = parseInt(e.key,10)-1;
          const btn = document.querySelector(`[data-setup="${SETUPS[idx]}"]`);
          if(btn){
            document.querySelectorAll('[data-setup]').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active'); currentSetup = SETUPS[idx];
            saveLocal();
          }
          return;
        }

        if(e.key==='s' || e.key==='S'){ e.preventDefault(); saveToFile(); return; }
        if(e.key==='r' || e.key==='R'){ e.preventDefault(); resetDay(); return; }
      });
    }

    function switchTab(name){
      // Buttons
      ['backtest','report','analytics'].forEach(id=>{
        $(`#tabBtn-${id}`).classList.toggle('active', id===name);
        $(`#tabBtn-${id}`).setAttribute('aria-selected', id===name ? 'true':'false');
      });
      // Panels
      ['backtest','report','analytics'].forEach(id=>{
        $(`#tab-${id}`).classList.toggle('active', id===name);
      });
      // Show/hide quick dock based on tab
      const qd = $('#quickDock');
      qd.classList.toggle('hidden', name!=='backtest');

      if(name==='report'){ updateReportView(); }
    }

    // ========= Boot =========
    function boot(){
      loadLocal();
      if(!currentDate) currentDate = new Date().toISOString().slice(0,10);
      wireScreenshot();
      wireEvents();
      setDate(currentDate);
      updateReportView();
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
